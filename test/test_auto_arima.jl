using Test
using Durbyn
using Random
import Durbyn.Arima: ArimaFit

const AIC_TOL = 15.0
const COEF_TOL = 0.2

function get_coef(fit, name::String)
    idx = findfirst(==(name), fit.coef.colnames)
    isnothing(idx) ? nothing : fit.coef.data[1, idx]
end

has_coef(fit, name::String) = name in fit.coef.colnames

get_p(fit) = fit.arma[1]
get_q(fit) = fit.arma[2]
get_P(fit) = fit.arma[3]
get_Q(fit) = fit.arma[4]
get_m(fit) = fit.arma[5]
get_d(fit) = fit.arma[6]
get_D(fit) = fit.arma[7]

@testset "Auto ARIMA Reference Tests" begin

    @testset "Monthly Seasonal (m=12)" begin
        monthly_data = [
            156.83145573290403, 198.01090980146668, 207.9294519090584, 192.50881106335353, 143.88220402427257,
            109.61247461878796, 51.02783684004386, 28.830574625122402, 33.3467665506287, 23.522525664450917, 48.66533667747763,
            107.43274507456638, 165.64013486015855, 200.15344049878215, 211.5155166091762, 202.1730030845587, 149.413779424248,
            114.8274687399386, 60.3144164424087, 29.459673433893094, 5.0319329715038, 25.255954513588897, 69.46784873284764,
            118.75490591398581, 138.50191829826542, 215.75333240194234, 220.07545455740012, 217.15814111236023, 191.90129990488526,
            108.8088676939804, 54.29519820628114, 37.54688841628041, -1.2454449934178413, 34.66284406168156, 48.04912269201285,
            107.40050982214626
        ]

        fit = auto_arima(monthly_data, 12)

        ref_aicc = 201.2989

        @test get_d(fit) + get_D(fit) >= 1
        @test get_m(fit) == 12
        @test isfinite(fit.aicc)
        @test fit.aicc < ref_aicc + AIC_TOL
    end

    @testset "Quarterly Seasonal (m=4)" begin
        quarterly_data = [
            255.5207840618145, 87.99560565039364, -50.22197639689352, 100.31688949671437, 242.67651141877238, 100.52525241597803,
            -46.08957390612448, 95.35610392578661, 261.43281111884124, 105.959923879395, -52.332682335543794, 110.88162945765853,
            257.26397049987094, 101.13289060185168, -62.98234513672319, 87.3748290530375, 263.8323849444473, 108.91573342476657,
            -61.783202628041785, 110.22246835230273, 245.01319786445208, 110.9737910820319, -53.64130850287849, 113.70236140280312
        ]

        fit = auto_arima(quarterly_data, 4)

        ref_sma1 = -0.653111
        ref_aicc = 154.2138

        @test get_m(fit) == 4

        if get_Q(fit) > 0 && has_coef(fit, "sma1")
            @test isapprox(get_coef(fit, "sma1"), ref_sma1, atol=COEF_TOL)
        end

        @test isfinite(fit.aicc)
        @test fit.aicc < ref_aicc + AIC_TOL
    end

    @testset "Daily Seasonal (m=7)" begin
        daily_data = [
            1749.349184518034, 2012.0710580391506, 1493.0154891668535, 462.047082761232, 50.865783828344284, 460.06967664987263,
            1046.5098920989092, 1732.6813259649934, 2044.4650005528904, 1457.6653933204234, 656.3330212062435, 53.85076527512874,
            302.9618975758385, 1000.6310493662936, 1806.1705543691553, 2074.918150381484, 1471.6715561040307, 681.5663548831715,
            55.187666687122146, 117.84251942586233, 1030.210501819249, 1760.1321040466987, 2097.794745263811, 1580.353318797828,
            490.2946924710491, -133.83617211844629, 321.1748761486958, 1026.0687262646018, 1831.4742310147008, 2111.9472142549675,
            1301.6816855005184, 636.8966872740124, 67.57821840581548, -4.331952059498036, 974.7489363552428, 1624.1873281795063
        ]

        fit = auto_arima(daily_data, 7)

        ref_sar1 = -0.6090622
        ref_aicc = 363.7812

        @test get_m(fit) == 7

        if get_P(fit) > 0 && has_coef(fit, "sar1")
            @test isapprox(get_coef(fit, "sar1"), ref_sar1, atol=COEF_TOL)
        end

        @test isfinite(fit.aicc)
        @test fit.aicc < ref_aicc + AIC_TOL
    end

    @testset "Hourly Seasonal (m=24)" begin
        hourly_data = [
            71.37918135156875, 85.8543432348506, 79.3066299785248, 88.19294702225602, 74.52408618413598, 84.38330781641443,
            115.56079010814668, 102.40505779052614, 87.25420321325205, 80.38382892783665, 72.13377425796332, 46.731426724867745,
            30.549222541945262, 22.478309134678916, 5.298309941546334, 6.5835758431834215, -14.532761281188694, -13.752146188889045,
            11.654961659112109, 23.679607106346317, 26.956866249535913, 52.26239608957695, 50.80004597793651, 60.94287490127781,
            48.83010084842864, 86.68838987000643, 84.05495480060645, 86.06584416580166, 111.4879720574784, 92.44965808952739,
            103.6212930503394, 96.27502856687921, 86.05268297846618, 62.85164253224801, 72.0989871692978, 52.06960406236867,
            33.237540663475635, 22.915531503795766, 25.096479486631594, 24.577070770996464, 4.03716379051701, 16.729657793875337,
            17.008242179578367, 32.82357605387345, 17.97418533364006, 39.860438966124455, 36.07701429609706, 41.82545719386261,
            62.462055622253864, 97.20672004658493, 83.0182777674507, 99.23832608858793, 121.29165042874155, 104.19097850654907,
            104.61251220128679, 104.72392728847008, 94.74827365170356, 94.24573313491871, 66.77858338924341, 42.585482039769644,
            37.32753690990771, 51.671441510808414, 18.20823249084842, 26.42778376467034, 3.0398876707858973, 19.466122730029763,
            19.123398367257554, 16.125321333077846, 15.29886562062449, 25.74054170566481, 36.27166701289651, 57.844144408882755,
            81.95238665680269, 89.0832254833273, 100.38285256092303, 108.50090948549702, 116.68981514762598, 107.71994371650905,
            101.54405738576708, 93.53370125543341, 90.96766772636944, 99.17768408897605, 72.12136512544116, 61.731781256486386,
            44.29800236372274, 44.29479716079315, 19.94448750712072, 28.79830754108969, 1.0201183482837113, 3.219090053820035,
            14.044953721984703, 14.622909376186058, 24.259667824694663, 13.590057683840271, 51.36043164778454, 57.392081392764894
        ]

        fit = auto_arima(hourly_data, 24)

        ref_aicc = 570.0322

        @test get_m(fit) == 24
        @test isfinite(fit.aicc)
        @test fit.aicc < ref_aicc + AIC_TOL * 2
    end

    @testset "Non-Seasonal (m=1)" begin
        no_seasonal_data = [
            97.6050489407213, 115.66030359421944, 109.55208728844406, 91.65541470371792, 85.24607237085254, 89.6443661655059,
            97.01577728014611, 104.33860351448578, 104.28238560313135, 111.58948171956203, 99.80718547190561, 97.25530601257535,
            92.42851598447066, 114.78920397777841, 103.4567675295882, 114.39737849488006, 103.95460179432608, 106.86776724365077,
            100.50976902283695, 100.3304086154929, 110.96348348012472, 112.00890359198776, 103.64812953321086, 90.26853823578205
        ]

        fit = auto_arima(no_seasonal_data, 1; seasonal=false)

        ref_intercept = 102.3865
        ref_aicc = 175.194

        @test get_D(fit) == 0

        if has_coef(fit, "intercept")
            @test isapprox(get_coef(fit, "intercept"), ref_intercept, atol=5.0)
        elseif has_coef(fit, "mean")
            @test isapprox(get_coef(fit, "mean"), ref_intercept, atol=5.0)
        end

        @test isfinite(fit.aicc)
        @test fit.aicc < ref_aicc + AIC_TOL
    end

    @testset "Strong Seasonal (m=12)" begin
        strong_seasonal_data = [
            202.7, 270.1, 313.1, 273.5, 209.7, 112.3, 5.0, -75.0, -109.4, -75.3, -16.6, 100.1, 201.6, 266.2, 297.9, 270.6, 200.0, 90.4,
            -8.1, -64.5, -85.8, -74.8, 5.4, 88.5, 192.7, 264.3, 285.3, 284.2, 195.7, 98.9, 5.0, -55.7, -99.7, -66.1, 1.4, 99.3, 195.8,
            270.7, 290.8, 277.1, 205.7, 103.1, 1.3, -77.3, -95.2, -84.1, -14.2, 98.5, 209.4, 276.4, 296.1, 267.0, 205.8, 103.6, 11.4,
            -69.5, -94.4, -76.1, 11.3, 99.9, 201.6, 258.8, 299.5, 279.8, 191.2, 76.2, 4.1, -65.9, -99.7, -89.8, 12.6, 82.8, 203.7,
            289.3, 299.4, 284.6, 190.8, 98.1, 13.9, -67.1, -117.6, -66.4, 1.3, 94.8, 226.8, 273.9, 319.0, 280.4, 199.6, 113.5, 4.6,
            -62.3, -102.2, -69.4, 0.2, 105.3, 215.0, 264.6, 277.7, 262.5, 182.3, 112.6, -1.8, -71.6, -90.0, -80.8, -6.0, 107.9, 209.8,
            262.3, 301.1, 273.4, 189.8, 96.6, 1.8, -78.5, -101.8, -52.8, -4.6, 100.1, 209.7, 278.7, 308.4, 268.1, 195.3, 114.5, -12.0,
            -73.4, -117.9, -76.1, 6.3, 103.6, 215.9, 262.3, 280.3, 271.4, 221.6, 104.7, -20.0, -81.7, -86.0, -70.8, -9.8, 94.4, 205.7,
            283.2, 287.0, 244.5, 198.5, 89.3, 2.1, -68.8, -92.9, -51.9, 1.7, 97.8, 185.7, 270.3, 292.2, 263.7, 216.4, 102.4, 7.4,
            -79.3, -104.0, -71.8, 4.2, 97.5, 212.6, 268.3, 304.9, 253.5, 201.0, 114.5, 5.3, -90.1, -108.7, -81.5, 0.6, 90.7, 196.2,
            284.9, 288.6, 291.5, 200.8, 104.5, -1.8, -69.9, -99.4, -80.4, -10.1, 104.0, 185.9, 286.6, 292.4, 275.0, 205.9, 100.4, -6.6, -84.7
        ]

        fit = auto_arima(strong_seasonal_data, 12)

        ref_aicc = 1431.235

        @test get_m(fit) == 12
        @test get_d(fit) + get_D(fit) >= 1
        @test isfinite(fit.aicc)
        @test fit.aicc < ref_aicc + AIC_TOL * 4
    end

    @testset "Model Selection Criteria" begin
        simple_seasonal = [
            100.0, 120.0, 130.0, 110.0, 100.0, 120.0, 130.0, 110.0,
            100.0, 120.0, 130.0, 110.0, 100.0, 120.0, 130.0, 110.0,
            100.0, 120.0, 130.0, 110.0, 100.0, 120.0, 130.0, 110.0
        ]

        fit = auto_arima(simple_seasonal, 4)

        @test get_m(fit) == 4
        # Perfectly periodic data → sigma2=0 → AIC/AICC/BIC = -Inf (perfect model)
        @test fit.aic == -Inf || isfinite(fit.aic)
        @test fit.aicc == -Inf || isfinite(fit.aicc)
        @test fit.bic == -Inf || isfinite(fit.bic)
    end

    @testset "Information Criterion Options" begin
        test_data = [
            97.6, 115.7, 109.6, 91.7, 85.2, 89.6, 97.0, 104.3, 104.3, 111.6, 99.8, 97.3,
            92.4, 114.8, 103.5, 114.4, 104.0, 106.9, 100.5, 100.3, 111.0, 112.0, 103.6, 90.3
        ]

        fit_aicc = auto_arima(test_data, 1; ic="aicc", seasonal=false)
        fit_aic = auto_arima(test_data, 1; ic="aic", seasonal=false)
        fit_bic = auto_arima(test_data, 1; ic="bic", seasonal=false)

        @test isfinite(fit_aicc.aicc)
        @test isfinite(fit_aic.aic)
        @test isfinite(fit_bic.bic)
    end

    @testset "Stepwise Search" begin
        test_data = [
            156.83, 198.01, 207.93, 192.51, 143.88, 109.61, 51.03, 28.83, 33.35, 23.52, 48.67, 107.43,
            165.64, 200.15, 211.52, 202.17, 149.41, 114.83, 60.31, 29.46, 5.03, 25.26, 69.47, 118.75
        ]

        fit_stepwise = auto_arima(test_data, 12; stepwise=true)

        @test isfinite(fit_stepwise.aicc)
        @test get_m(fit_stepwise) == 12
    end

    @testset "Model Structure" begin
        test_data = [
            100.0, 110.0, 120.0, 130.0, 100.0, 110.0, 120.0, 130.0,
            100.0, 110.0, 120.0, 130.0, 100.0, 110.0, 120.0, 130.0
        ]

        fit = auto_arima(test_data, 4)

        @test length(fit.arma) == 7
        @test all(fit.arma .>= 0)
        @test get_m(fit) == 4
    end

    @testset "Near-Constant Series" begin
        # Use fixed seed for reproducibility
        Random.seed!(42)
        constant_data = fill(100.0, 24) .+ randn(24) * 1e-10

        fit = auto_arima(constant_data, 4)

        # For near-constant data, expect a simple model (p + q should be small)
        @test get_p(fit) + get_q(fit) <= 1
        @test isfinite(fit.aicc)
    end

    @testset "Trended Data" begin
        trend_data = collect(1.0:30.0) .+ randn(30) * 0.1

        fit = auto_arima(trend_data, 1; seasonal=false)

        @test get_d(fit) >= 1 || isfinite(fit.aicc)
    end

    @testset "Constant Series" begin
        # Bug fix: constant series should not crash
        constant_data = fill(2.0, 24)
        fit = auto_arima(constant_data, 12)
        @test fit isa ArimaFit
        @test fit.sigma2 >= 0.0 || isnan(fit.sigma2)
    end

    @testset "Trailing Missings Trimmed" begin
        # Bug fix: trailing missings should be trimmed properly
        y = [1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, missing, missing]
        fit = auto_arima(y, 1; seasonal=false)
        @test fit isa ArimaFit
        @test isnothing(fit.aicc) || isfinite(fit.aicc) || fit.aicc == Inf
    end

    @testset "Leading and Trailing Missings" begin
        # Both leading and trailing missings should be trimmed
        y = [missing, missing, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, missing]
        fit = auto_arima(y, 1; seasonal=false)
        @test fit isa ArimaFit
    end

    @testset "All Missing Data Error" begin
        # Bug fix: should throw clear error for all-missing data
        all_missing = [missing, missing, missing, missing]
        @test_throws ErrorException auto_arima(all_missing, 1)
    end

    @testset "m < 1 Validation" begin
        # Bug fix: m < 1 should throw for seasonal, default to 1 for non-seasonal
        @test_throws ArgumentError auto_arima(randn(30), 0; seasonal=true)

        # For non-seasonal, m < 1 should work (internally set to 1)
        fit = auto_arima(randn(30), 0; seasonal=false)
        @test !isnothing(fit)
    end

    @testset "Long Series (n=769)" begin
        complex_data = [
            102.9, 101.1, 100.4, 91.5, 77.2, 104.5, 108.2, 101.4, 105.0, 105.7, 84.5, 112.6, 83.9,
            86.0, 96.9, 105.7, 113.5, 102.2, 95.5, 96.1, 102.6, 107.2, 95.8, 103.8, 88.1, 124.5,
            101.6, 120.7, 117.4, 124.3, 127.8, 110.9, 96.8, 116.7, 121.6, 99.4, 113.9, 93.8, 99.5,
            93.9, 136.5, 89.9, 115.2, 106.7, 109.5, 98.6, 107.3, 98.2, 98.7, 106.6, 118.0, 110.1,
            109.8, 126.1, 97.4, 107.0, 90.6, 122.1, 118.4, 92.6, 102.7, 123.0, 103.4, 104.1, 119.2,
            94.3, 115.0, 106.1, 110.9, 118.9, 108.5, 108.8, 111.1, 117.0, 94.2, 109.9, 90.9, 123.4,
            118.7, 104.8, 112.8, 84.9, 94.0, 122.1, 114.5, 109.1, 127.4, 118.4, 98.1, 114.8, 110.0,
            82.3, 101.8, 107.8, 114.7, 100.6, 100.0, 95.8, 102.6, 115.4, 117.6, 111.6, 96.2, 103.1,
            98.0, 94.0, 141.0, 113.0, 110.5, 96.9, 99.5, 107.2, 115.3, 109.2, 101.2, 88.3, 114.0,
            125.6, 123.3, 107.2, 125.5, 115.1, 113.4, 130.2, 106.4, 105.4, 99.9, 124.4, 113.4,
            116.4, 118.6, 115.0, 108.0, 105.4, 125.8, 116.5, 103.9, 105.5, 107.2, 110.9, 94.7,
            126.8, 120.4, 98.1, 106.8, 104.7, 120.0, 108.5, 122.3, 108.4, 107.6, 112.2, 106.8, 123.1,
            114.7, 111.3, 109.9, 122.0, 128.6, 119.7, 115.2, 126.1, 118.0, 125.4, 118.9, 115.7, 106.1,
            114.6, 123.2, 117.8, 136.7, 114.1, 96.4, 96.3, 108.2, 106.8, 99.4, 120.6, 121.3, 104.2, 119.8,
            123.9, 127.1, 131.1, 111.3, 138.9, 115.6, 107.1, 116.5, 118.9, 102.4, 125.9, 121.1, 125.0, 114.2,
            120.6, 112.0, 125.1, 118.6, 149.6, 137.7, 128.8, 110.3, 131.4, 137.5, 113.2, 115.2, 120.9, 113.4,
            116.5, 111.7, 137.5, 116.9, 125.5, 117.4, 110.8, 132.9, 130.8, 128.0, 123.7, 150.9, 100.2, 122.5,
            127.9, 114.3, 111.0, 113.7, 121.8, 117.2, 120.2, 112.6, 121.8, 123.8, 130.2, 113.2, 118.6, 123.6,
            111.0, 114.2, 127.7, 128.6, 122.7, 132.1, 119.6, 139.3, 119.7, 126.1, 119.8, 119.1, 105.3, 136.2,
            102.1, 149.6, 122.7, 117.0, 115.5, 135.6, 120.2, 127.9, 128.4, 133.0, 141.8, 139.1, 114.5, 121.4,
            126.5, 119.2, 121.5, 137.9, 117.2, 129.0, 133.2, 109.2, 128.1, 145.4, 130.3, 123.6, 130.6, 118.1,
            124.6, 115.0, 128.2, 127.6, 121.1, 139.0, 130.7, 137.1, 109.9, 134.3, 131.1, 145.8, 138.3, 133.8,
            114.6, 132.2, 137.8, 130.2, 132.8, 129.6, 128.3, 127.2, 124.4, 144.8, 135.6, 134.4, 118.2, 126.6,
            132.3, 135.0, 140.2, 120.9, 149.6, 126.4, 132.8, 124.1, 104.5, 132.4, 156.5, 124.6, 133.5, 132.5,
            139.0, 141.3, 136.2, 115.6, 135.4, 150.3, 119.6, 129.6, 134.5, 134.0, 122.7, 135.6, 131.5, 142.7,
            131.9, 142.8, 146.4, 134.1, 155.4, 132.5, 128.8, 132.9, 141.4, 122.8, 143.1, 134.5, 139.3, 109.9,
            125.0, 120.6, 151.2, 135.5, 130.6, 134.7, 138.7, 138.0, 137.6, 131.4, 152.6, 143.8, 138.8, 136.2,
            125.4, 137.5, 136.3, 128.6, 136.0, 139.7, 125.1, 123.0, 139.1, 140.6, 126.7, 143.0, 143.0, 140.3,
            134.4, 132.2, 136.8, 133.8, 136.9, 150.0, 151.3, 141.5, 145.4, 139.9, 140.2, 130.9, 144.8, 120.1,
            147.6, 126.2, 120.2, 138.3, 123.8, 146.6, 144.6, 155.8, 133.8, 137.2, 134.5, 157.1, 136.5, 130.5,
            157.3, 144.4, 149.7, 137.2, 144.9, 132.7, 146.9, 170.1, 133.9, 124.5, 141.8, 147.5, 127.4, 153.4,
            148.0, 133.2, 146.6, 151.7, 151.3, 143.8, 139.5, 151.8, 141.5, 134.6, 145.6, 135.5, 140.1, 138.0,
            129.3, 143.8, 160.7, 136.2, 138.6, 137.5, 137.0, 145.8, 153.5, 126.4, 126.0, 144.5, 142.7, 149.9,
            148.6, 147.2, 147.2, 144.2, 145.0, 146.5, 155.7, 151.6, 132.4, 133.2, 134.5, 142.2, 151.6, 146.5,
            126.8, 158.1, 184.7, 156.3, 155.8, 137.4, 133.9, 156.6, 155.5, 138.2, 152.9, 158.5, 158.8, 148.3,
            154.9, 148.1, 157.4, 143.3, 130.2, 139.9, 162.8, 148.8, 140.9, 133.7, 137.5, 138.0, 155.5, 160.7,
            153.5, 126.4, 138.0, 156.9, 142.7, 157.7, 160.4, 157.1, 131.7, 161.5, 165.8, 161.0, 152.5, 140.8,
            140.1, 166.2, 147.5, 136.1, 134.7, 148.4, 161.5, 139.6, 152.3, 157.3, 155.9, 138.1, 156.0, 141.0,
            131.9, 147.1, 148.8, 148.4, 148.4, 153.6, 150.4, 146.6, 168.6, 159.2, 171.7, 147.2, 149.8, 147.8,
            155.8, 145.9, 153.3, 158.7, 149.3, 157.7, 171.0, 170.2, 158.7, 169.9, 160.8, 150.8, 147.5, 167.9,
            157.2, 154.2, 157.6, 141.2, 153.0, 151.6, 144.8, 154.9, 155.1, 158.5, 160.7, 154.4, 142.4, 164.6,
            165.9, 155.1, 168.3, 154.9, 166.1, 160.3, 136.6, 160.0, 181.8, 152.4, 147.9, 157.9, 163.5, 153.3,
            171.1, 163.9, 154.1, 167.5, 150.9, 159.4, 157.6, 175.7, 166.8, 157.6, 152.3, 157.3, 147.8, 164.1,
            155.5, 174.6, 156.1, 167.8, 143.6, 153.8, 167.6, 178.1, 150.7, 156.8, 152.0, 160.7, 157.3, 158.7,
            138.8, 158.8, 144.4, 174.4, 162.0, 154.3, 175.9, 170.8, 157.3, 162.5, 151.0, 156.6, 153.0, 164.4,
            168.6, 159.2, 149.5, 159.3, 153.6, 165.1, 185.8, 160.5, 166.5, 143.4, 177.7, 153.9, 172.9, 146.9,
            161.3, 168.1, 156.4, 149.3, 160.0, 150.3, 144.9, 180.3, 142.9, 164.5, 163.6, 153.8, 183.4, 170.0,
            157.2, 151.3, 160.0, 150.2, 164.2, 165.1, 163.6, 152.9, 162.5, 156.4, 176.7, 166.5, 160.3, 163.6,
            175.5, 169.6, 176.6, 192.9, 151.0, 155.5, 165.8, 158.3, 163.6, 193.0, 156.4, 162.9, 165.0, 149.8,
            168.6, 172.7, 161.6, 182.4, 169.8, 138.2, 172.4, 180.7, 184.0, 175.4, 153.0, 174.0, 188.5, 174.6,
            175.8, 156.7, 186.4, 182.3, 179.3, 170.7, 161.9, 160.5, 157.8, 180.1, 154.6, 176.8, 168.6, 156.0,
            162.5, 173.2, 155.5, 180.7, 180.5, 167.5, 172.9, 174.4, 153.7, 180.9, 145.6, 147.6, 191.7, 178.6,
            167.4, 178.6, 176.2, 172.2, 166.9, 185.3, 182.5, 177.0, 152.1, 179.2, 163.8, 184.5, 165.4, 189.4,
            179.7, 181.8, 186.4
        ]

        fit = auto_arima(complex_data, 1; seasonal=false)

        ref_aicc = 5539.21

        @test get_d(fit) >= 1
        @test isfinite(fit.aicc)
        @test fit.aicc < ref_aicc * 1.1
    end

end

@testset "Auto ARIMA Parity Regression Tests" begin

    # Nile river flow data (1871-1970) — standard R dataset
    nile = [
        1120.0, 1160.0, 963.0, 1210.0, 1160.0, 1160.0, 813.0, 1230.0, 1370.0, 1140.0,
        995.0, 935.0, 1110.0, 994.0, 1020.0, 960.0, 1180.0, 799.0, 958.0, 1140.0,
        1100.0, 1210.0, 1150.0, 1250.0, 1260.0, 1220.0, 1030.0, 1100.0, 774.0, 840.0,
        874.0, 694.0, 940.0, 833.0, 701.0, 916.0, 692.0, 1020.0, 1050.0, 969.0,
        831.0, 726.0, 456.0, 824.0, 702.0, 1120.0, 1100.0, 832.0, 764.0, 821.0,
        768.0, 845.0, 864.0, 862.0, 698.0, 845.0, 744.0, 796.0, 1040.0, 759.0,
        781.0, 865.0, 845.0, 944.0, 984.0, 897.0, 822.0, 1010.0, 771.0, 676.0,
        649.0, 846.0, 812.0, 742.0, 801.0, 1040.0, 860.0, 874.0, 848.0, 890.0,
        744.0, 749.0, 838.0, 1050.0, 918.0, 986.0, 797.0, 923.0, 975.0, 815.0,
        1020.0, 906.0, 901.0, 1170.0, 912.0, 746.0, 919.0, 718.0, 714.0, 740.0,
    ]

    @testset "Constant toggle: d=1 prefers no-drift (Nile)" begin
        # Regression test for !constant toggle fix in stepwise search.
        # With d=1, ARIMA(1,1,1) WITHOUT drift should be selected
        # because the no-drift model has lower BIC. Before the fix, Julia
        # always tried the same constant setting, never toggling to !constant.
        fit = auto_arima(nile, 1; d=1, seasonal=false, ic="bic")

        # Model should NOT include drift — the toggled (no-drift) model wins on BIC
        @test !("drift" in fit.coef.colnames)

        # R reference: BIC ≈ 1275.04
        @test isapprox(fit.bic, 1275.04, rtol=0.005)
    end

    @testset "Constant toggle: nonseasonal auto selects no-drift (Nile)" begin
        # Same bug, different entry point: seasonal=false without forced d
        fit = auto_arima(nile, 1; seasonal=false)

        # Should select ARIMA(1,1,1) without drift
        @test get_p(fit) == 1
        @test get_d(fit) == 1
        @test get_q(fit) == 1
        @test !("drift" in fit.coef.colnames)
    end

    @testset "Approximation refit uses IC-sorted order" begin
        # Regression test for refit ordering fix.
        # When approximation=true, the refit loop should try models in
        # best-IC-first order (using icorder[i]), not sequential order.
        # The approximate search may follow a different path (different ICs during
        # exploration), but the final refit should produce a competitive model.

        # AirPassengers (monthly airline data, n=144, m=12)
        airpassengers = [
            112.0, 118.0, 132.0, 129.0, 121.0, 135.0, 148.0, 148.0, 136.0, 119.0, 104.0, 118.0,
            115.0, 126.0, 141.0, 135.0, 125.0, 149.0, 170.0, 170.0, 158.0, 133.0, 114.0, 140.0,
            145.0, 150.0, 178.0, 163.0, 172.0, 178.0, 199.0, 199.0, 184.0, 162.0, 146.0, 166.0,
            171.0, 180.0, 193.0, 181.0, 183.0, 218.0, 230.0, 242.0, 209.0, 191.0, 172.0, 194.0,
            196.0, 196.0, 236.0, 235.0, 229.0, 243.0, 264.0, 272.0, 237.0, 211.0, 180.0, 201.0,
            204.0, 188.0, 235.0, 227.0, 234.0, 264.0, 302.0, 293.0, 259.0, 229.0, 203.0, 229.0,
            242.0, 233.0, 267.0, 269.0, 270.0, 315.0, 364.0, 347.0, 312.0, 274.0, 237.0, 278.0,
            284.0, 277.0, 317.0, 313.0, 318.0, 374.0, 413.0, 405.0, 355.0, 306.0, 271.0, 306.0,
            315.0, 301.0, 356.0, 348.0, 355.0, 422.0, 465.0, 467.0, 404.0, 347.0, 305.0, 336.0,
            340.0, 318.0, 362.0, 348.0, 363.0, 435.0, 491.0, 505.0, 404.0, 359.0, 310.0, 337.0,
            360.0, 342.0, 406.0, 396.0, 420.0, 472.0, 548.0, 559.0, 463.0, 407.0, 362.0, 405.0,
            417.0, 391.0, 419.0, 461.0, 472.0, 535.0, 622.0, 606.0, 508.0, 461.0, 390.0, 432.0,
        ]

        fit_exact = auto_arima(airpassengers, 12; approximation=false, stepwise=true)
        fit_approx = auto_arima(airpassengers, 12; approximation=true, stepwise=true)

        # Both should produce valid, competitive models
        @test isfinite(fit_approx.aicc)
        @test isfinite(fit_exact.aicc)

        # Approximation refit should produce AICc within 5% of exact search
        # (the refit ordering ensures the best explored model is selected)
        @test fit_approx.aicc < fit_exact.aicc * 1.05

        # Both should have d=1, D=1 (same differencing on AirPassengers)
        @test get_d(fit_approx) == get_d(fit_exact)
        @test get_D(fit_approx) == get_D(fit_exact)
    end

end
